<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head('Assigning Seats')}"></head>
<body>
    <th:block th:insert="~{fragments/navbar :: navbar}"></th:block>
    <section class="section">
        <div class="container">
            <div th:insert="~{fragments/notifications :: notifications}"></div>
            
            <!-- Assignment Header -->
            <div class="columns is-centered mb-4">
                <div class="column is-10">
                    <div class="title-card has-text-white p-5">
                        <h1 class="title is-4 has-text-white">Assigning seats</h1>
                        <p class="subtitle is-6 has-text-white mb-0" th:if="${section != null}" 
                           th:text="'For ' + ${section.gradeLevel.displayValue} + ' - ' + ${section.sectionName}">For Grade 11 - Section A</p>
                    </div>
                </div>
            </div>

            <!-- Assignment Grid -->
            <div class="columns is-centered mb-4">
                <div class="column is-10">
                    <div class="box">
                        <div id="seat-grid" class="seat-grid" th:attr="data-layout=${layoutType}">
                            <!-- Grid will be generated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Assignment Form -->
            <div class="columns is-centered mb-4">
                <div class="column is-10">
                    <div class="box">
                        <form th:action="@{/sections/{id}/assignments/save(id=${sectionId})}" method="post">
                            <input type="hidden" name="layoutType" th:value="${layoutType}">
                            <input type="hidden" name="assignmentData" id="assignmentData">
                            
                            <div class="field">
                                <label class="label" for="assignmentName">Assignment Name</label>
                                <div class="control">
                                    <input type="text" class="input" name="assignmentName" 
                                           placeholder="Enter assignment name..." required>
                                </div>
                            </div>

                            <div class="field">
                                <label class="label">Assignment Presets</label>
                                <div class="control">
                                    <div class="select">
                                        <select id="assignmentPreset">
                                            <option value="">Select preset...</option>
                                            <option value="A_TO_Z">A-Z (Alphabetical)</option>
                                            <option value="Z_TO_A">Z-A (Reverse alphabetical)</option>
                                            <option value="RANDOM">Random</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="field is-grouped">
                                <div class="control">
                                    <button type="submit" class="button is-primary">Finish</button>
                                </div>
                                <div class="control">
                                    <button type="button" class="button" onclick="resetAssignment()">Reset</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <style>
        .seat-grid {
            display: grid;
            gap: 8px;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .seat {
            width: 50px;
            height: 50px;
            border: 2px solid #00BCD4;
            border-radius: 6px;
            background-color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            line-height: 1.2;
        }
        
        .seat.available {
            border-color: #00BCD4;
            background-color: white;
        }
        
        .seat.available:hover {
            background-color: #e0f7fa;
            transform: scale(1.05);
        }
        
        .seat.occupied {
            background-color: #00BCD4;
            color: white;
            border-color: #008ba3;
        }
        
        .seat.occupied:hover {
            background-color: #008ba3;
        }
        
        .seat.disabled {
            background-color: #e9ecef;
            border-color: #dee2e6;
            cursor: not-allowed;
        }
        
        .seat-number {
            position: absolute;
            top: -8px;
            left: -8px;
            background-color: #6c757d;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 0.6rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>

    <script th:inline="javascript">
        const layoutType = /*[[${layoutType}]]*/ 'NORMAL';
        const sectionId = /*[[${sectionId}]]*/ 1;
        
        const layouts = {
            'NORMAL': { rows: 10, cols: 10, disabled: [] },
            'SMALL': { rows: 5, cols: 5, disabled: [] },
            'ROWS': { rows: 8, cols: 6, disabled: [] },
            'U_SHAPE': { rows: 8, cols: 6, disabled: generateUShapeDisabled(8, 6) },
            'GROUPS': { rows: 6, cols: 6, disabled: generateGroupsDisabled(6, 6) }
        };
        
        let assignments = {}; // { "row-col": "studentName" }
        let students = []; // Will be loaded from server
        
        document.addEventListener('DOMContentLoaded', function() {
            loadStudents();
            generateGrid();
            setupPresetHandler();
        });
        
        function loadStudents() {
            // TODO: Load students from server via AJAX
            // For now, using mock data
            students = [
                { id: 1, name: "John Doe" },
                { id: 2, name: "Jane Smith" },
                { id: 3, name: "Bob Johnson" },
                { id: 4, name: "Alice Brown" }
            ];
        }
        
        function generateGrid() {
            const grid = document.getElementById('seat-grid');
            const layout = layouts[layoutType];
            
            grid.style.gridTemplateColumns = `repeat(${layout.cols}, 1fr)`;
            grid.innerHTML = '';
            
            for (let r = 0; r < layout.rows; r++) {
                for (let c = 0; c < layout.cols; c++) {
                    const seat = document.createElement('div');
                    const seatId = `${r}-${c}`;
                    
                    seat.className = 'seat';
                    seat.dataset.row = r;
                    seat.dataset.col = c;
                    seat.dataset.seatId = seatId;
                    
                    if (layout.disabled.includes(seatId)) {
                        seat.classList.add('disabled');
                    } else {
                        seat.classList.add('available');
                        seat.onclick = () => handleSeatClick(seatId);
                    }
                    
                    grid.appendChild(seat);
                }
            }
        }
        
        function handleSeatClick(seatId) {
            const seat = document.querySelector(`[data-seat-id="${seatId}"]`);
            
            if (seat.classList.contains('occupied')) {
                // Show options for occupied seat
                if (confirm('Remove student from this seat?')) {
                    removeAssignment(seatId);
                }
            } else if (seat.classList.contains('available')) {
                // Show student selection for empty seat
                showStudentSelection(seatId);
            }
        }
        
        function showStudentSelection(seatId) {
            // TODO: Show modal with student list
            // For now, using simple prompt
            const availableStudents = students.filter(s => 
                !Object.values(assignments).includes(s.name)
            );
            
            if (availableStudents.length === 0) {
                alert('No more students to assign');
                return;
            }
            
            const studentNames = availableStudents.map(s => s.name).join('\n');
            const selectedName = prompt(`Select student for seat ${seatId}:\n\n${studentNames}`);
            
            if (selectedName && availableStudents.some(s => s.name === selectedName)) {
                assignStudent(seatId, selectedName);
            }
        }
        
        function assignStudent(seatId, studentName) {
            assignments[seatId] = studentName;
            updateSeatDisplay(seatId, studentName);
            updateAssignmentData();
        }
        
        function removeAssignment(seatId) {
            delete assignments[seatId];
            updateSeatDisplay(seatId, null);
            updateAssignmentData();
        }
        
        function updateSeatDisplay(seatId, studentName) {
            const seat = document.querySelector(`[data-seat-id="${seatId}"]`);
            
            if (studentName) {
                seat.classList.remove('available');
                seat.classList.add('occupied');
                seat.textContent = getInitials(studentName);
                seat.title = studentName;
            } else {
                seat.classList.remove('occupied');
                seat.classList.add('available');
                seat.textContent = '';
                seat.title = '';
            }
        }
        
        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase();
        }
        
        function updateAssignmentData() {
            document.getElementById('assignmentData').value = JSON.stringify(assignments);
        }
        
        function setupPresetHandler() {
            document.getElementById('assignmentPreset').addEventListener('change', function(e) {
                if (e.target.value) {
                    applyPreset(e.target.value);
                }
            });
        }
        
        function applyPreset(presetType) {
            if (Object.keys(assignments).length > 0) {
                if (!confirm('This will clear current assignments. Continue?')) {
                    return;
                }
            }
            
            assignments = {};
            const availableSeats = getAvailableSeats();
            let sortedStudents = [...students];
            
            switch (presetType) {
                case 'A_TO_Z':
                    sortedStudents.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'Z_TO_A':
                    sortedStudents.sort((a, b) => b.name.localeCompare(a.name));
                    break;
                case 'RANDOM':
                    sortedStudents = shuffleArray(sortedStudents);
                    break;
            }
            
            for (let i = 0; i < Math.min(sortedStudents.length, availableSeats.length); i++) {
                assignments[availableSeats[i]] = sortedStudents[i].name;
            }
            
            refreshGrid();
            updateAssignmentData();
        }
        
        function getAvailableSeats() {
            const layout = layouts[layoutType];
            const seats = [];
            
            for (let r = 0; r < layout.rows; r++) {
                for (let c = 0; c < layout.cols; c++) {
                    const seatId = `${r}-${c}`;
                    if (!layout.disabled.includes(seatId)) {
                        seats.push(seatId);
                    }
                }
            }
            return seats;
        }
        
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }
        
        function refreshGrid() {
            Object.keys(assignments).forEach(seatId => {
                updateSeatDisplay(seatId, assignments[seatId]);
            });
            
            // Clear unassigned seats
            document.querySelectorAll('.seat.available').forEach(seat => {
                if (!assignments[seat.dataset.seatId]) {
                    seat.classList.remove('occupied');
                    seat.classList.add('available');
                    seat.textContent = '';
                    seat.title = '';
                }
            });
        }
        
        function resetAssignment() {
            if (confirm('Reset all seat assignments?')) {
                assignments = {};
                refreshGrid();
                updateAssignmentData();
                document.getElementById('assignmentPreset').value = '';
            }
        }
        
        function generateUShapeDisabled(rows, cols) {
            const disabled = [];
            const centerCols = Math.floor(cols / 3);
            const startCol = Math.floor((cols - centerCols) / 2);
            
            for (let r = 1; r < rows - 1; r++) {
                for (let c = startCol; c < startCol + centerCols; c++) {
                    disabled.push(`${r}-${c}`);
                }
            }
            return disabled;
        }
        
        function generateGroupsDisabled(rows, cols) {
            const disabled = [];
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    if ((r + 1) % 3 === 0 || (c + 1) % 3 === 0) {
                        disabled.push(`${r}-${c}`);
                    }
                }
            }
            return disabled;
        }
    </script>
</body>
</html>
