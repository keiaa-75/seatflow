<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head('Assigning Seats')}"></head>
<body>
    <th:block th:insert="~{fragments/navbar :: navbar}"></th:block>
    <section class="section">
        <div class="container">
            <div th:insert="~{fragments/notifications :: notifications}"></div>
            
            <!-- Assignment Header -->
            <div class="columns is-centered mb-4">
                <div class="column is-10">
                    <div class="title-card has-text-white p-5">
                        <h1 class="title is-4 has-text-white">Assigning seats</h1>
                        <p class="subtitle is-6 has-text-white mb-0" th:if="${section != null}" 
                           th:text="'For ' + ${section.gradeLevel.displayValue} + ' - ' + ${section.sectionName}">For Grade 11 - Section A</p>
                    </div>
                </div>
            </div>

            <!-- Assignment Grid -->
            <div class="columns is-centered mb-4">
                <div class="column is-10">
                    <div class="box">
                        <div id="seat-grid" class="seat-grid" th:attr="data-layout=${layoutType}">
                            <!-- Grid will be generated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Assignment Form -->
            <div class="columns is-centered mb-4">
                <div class="column is-10">
                    <div class="box">
                        <form th:action="@{/sections/{id}/assignments/save(id=${sectionId})}" method="post">
                            <input type="hidden" name="layoutType" th:value="${layoutType}">
                            <input type="hidden" name="assignmentData" id="assignmentData">
                            
                            <div class="field">
                                <label class="label" for="assignmentName">Assignment Name</label>
                                <div class="control">
                                    <input type="text" class="input" name="assignmentName" 
                                           placeholder="Enter assignment name..." required>
                                </div>
                            </div>

                            <div class="field">
                                <label class="label">Assignment Presets</label>
                                <div class="control">
                                    <div class="select">
                                        <select id="assignmentPreset">
                                            <option value="">Select preset...</option>
                                            <option value="A_TO_Z">A-Z (Alphabetical)</option>
                                            <option value="Z_TO_A">Z-A (Reverse alphabetical)</option>
                                            <option value="RANDOM">Random</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="field is-grouped">
                                <div class="control">
                                    <button type="submit" class="button is-primary">Finish</button>
                                </div>
                                <div class="control">
                                    <button type="button" class="button" onclick="resetAssignment()">Reset</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <style>
        .seat-grid {
            display: grid;
            gap: 8px;
            max-width: 100%;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            overflow-x: auto;
            /* Ensure the grid fits within the viewport */
            box-sizing: border-box;
        }

        .seat {
            min-width: 40px;
            min-height: 40px;
            width: 8vw;
            height: 8vw;
            max-width: 60px;
            max-height: 60px;
            border: 2px solid #00BCD4;
            border-radius: 6px;
            background-color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            text-align: center;
            line-height: 1.2;
            aspect-ratio: 1 / 1; /* Maintain square shape */
            /* Improve touch affordance on mobile */
            touch-action: manipulation;
        }

        .seat.available {
            border-color: #00BCD4;
            background-color: white;
        }

        .seat.available:hover,
        .seat.available:focus {
            background-color: #e0f7fa;
            transform: scale(1.05);
        }

        .seat.occupied {
            background-color: #00BCD4;
            color: white;
            border-color: #008ba3;
        }

        .seat.occupied:hover,
        .seat.occupied:focus {
            background-color: #008ba3;
        }

        .seat.disabled {
            background-color: #e9ecef;
            border-color: #dee2e6;
            cursor: not-allowed;
        }

        .seat-number {
            position: absolute;
            top: -8px;
            left: -8px;
            background-color: #6c757d;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 0.6rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Mobile-specific styles */
        @media (max-width: 768px) {
            .seat-grid {
                padding: 10px;
                gap: 6px;
            }

            .seat {
                min-width: 30px;
                min-height: 30px;
                width: 12vw;
                height: 12vw;
                max-width: 50px;
                max-height: 50px;
                font-size: 0.6rem;
            }
        }

        @media (max-width: 480px) {
            .seat-grid {
                padding: 8px;
                gap: 4px;
            }

            .seat {
                min-width: 25px;
                min-height: 25px;
                width: 15vw;
                height: 15vw;
                max-width: 40px;
                max-height: 40px;
                font-size: 0.5rem;
            }
        }
    </style>

    <script th:inline="javascript">
        const layoutType = /*[[${layoutType}]]*/ 'NORMAL';
        const sectionId = /*[[${sectionId}]]*/ 1;

        let layouts = {}; // Will be loaded from API
        let currentLayout = null; // Current selected layout
        let assignments = {}; // { "row-col": "studentName" }
        let students = []; // Will be loaded from server

        document.addEventListener('DOMContentLoaded', function() {
            Promise.all([loadStudents(), fetchLayouts()]).then(() => {
                currentLayout = layouts[layoutType];
                if (currentLayout) {
                    generateGrid();
                    setupPresetHandler();
                } else {
                    console.error('Layout not found:', layoutType);
                }
            });

            // Add resize listener to handle window resizing
            window.addEventListener('resize', handleResize);
        });

        function handleResize() {
            // Add a small delay to prevent excessive calls during resize
            clearTimeout(window.resizeTimer);
            window.resizeTimer = setTimeout(function() {
                // Regenerate the grid to adjust to new dimensions
                // This will use the CSS to handle responsive sizing
                console.log('Window resized, grid adjusted via CSS');
            }, 250);
        }
        
        async function loadStudents() {
            try {
                // TODO: Load students from server via AJAX
                // For now, using mock data
                students = [
                    { id: 1, name: "John Doe" },
                    { id: 2, name: "Jane Smith" },
                    { id: 3, name: "Bob Johnson" },
                    { id: 4, name: "Alice Brown" }
                ];
            } catch (error) {
                console.error('Failed to load students:', error);
            }
        }
        
        async function fetchLayouts() {
            try {
                const response = await fetch('/api/layouts');
                const layoutData = await response.json();
                
                // Convert array to object keyed by presetId
                layouts = layoutData.reduce((acc, layout) => {
                    if (layout.presetId) {
                        acc[layout.presetId] = {
                            rows: layout.rows,
                            cols: layout.columns,
                            disabled: layout.disabledSeats || []
                        };
                    }
                    return acc;
                }, {});
                
            } catch (error) {
                console.error('Failed to fetch layouts:', error);
            }
        }
        
        function generateGrid() {
            const grid = document.getElementById('seat-grid');
            
            if (!currentLayout) {
                console.error('No current layout selected');
                return;
            }

            grid.style.gridTemplateColumns = `repeat(${currentLayout.cols}, 1fr)`;
            grid.innerHTML = '';

            for (let r = 0; r < currentLayout.rows; r++) {
                for (let c = 0; c < currentLayout.cols; c++) {
                    const seat = document.createElement('div');
                    const seatId = `${r}-${c}`;

                    seat.className = 'seat';
                    seat.dataset.row = r;
                    seat.dataset.col = c;
                    seat.dataset.seatId = seatId;

                    if (currentLayout.disabled.includes(seatId)) {
                        seat.classList.add('disabled');
                    } else {
                        seat.classList.add('available');

                        // Add both click and touch events for better mobile experience
                        seat.addEventListener('click', () => handleSeatClick(seatId));
                        seat.addEventListener('touchstart', (e) => {
                            e.preventDefault(); // Prevent default touch behavior that might interfere
                            handleSeatClick(seatId);
                        });
                    }

                    grid.appendChild(seat);
                }
            }
        }
        
        function handleSeatClick(seatId) {
            const seat = document.querySelector(`[data-seat-id="${seatId}"]`);
            
            if (seat.classList.contains('occupied')) {
                // Show options for occupied seat
                if (confirm('Remove student from this seat?')) {
                    removeAssignment(seatId);
                }
            } else if (seat.classList.contains('available')) {
                // Show student selection for empty seat
                showStudentSelection(seatId);
            }
        }
        
        function showStudentSelection(seatId) {
            // TODO: Show modal with student list
            // For now, using simple prompt
            const availableStudents = students.filter(s => 
                !Object.values(assignments).includes(s.name)
            );
            
            if (availableStudents.length === 0) {
                alert('No more students to assign');
                return;
            }
            
            const studentNames = availableStudents.map(s => s.name).join('\n');
            const selectedName = prompt(`Select student for seat ${seatId}:\n\n${studentNames}`);
            
            if (selectedName && availableStudents.some(s => s.name === selectedName)) {
                assignStudent(seatId, selectedName);
            }
        }
        
        function assignStudent(seatId, studentName) {
            assignments[seatId] = studentName;
            updateSeatDisplay(seatId, studentName);
            updateAssignmentData();
        }
        
        function removeAssignment(seatId) {
            delete assignments[seatId];
            updateSeatDisplay(seatId, null);
            updateAssignmentData();
        }
        
        function updateSeatDisplay(seatId, studentName) {
            const seat = document.querySelector(`[data-seat-id="${seatId}"]`);
            
            if (studentName) {
                seat.classList.remove('available');
                seat.classList.add('occupied');
                seat.textContent = getInitials(studentName);
                seat.title = studentName;
            } else {
                seat.classList.remove('occupied');
                seat.classList.add('available');
                seat.textContent = '';
                seat.title = '';
            }
        }
        
        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase();
        }
        
        function updateAssignmentData() {
            document.getElementById('assignmentData').value = JSON.stringify(assignments);
        }
        
        function setupPresetHandler() {
            document.getElementById('assignmentPreset').addEventListener('change', function(e) {
                if (e.target.value) {
                    applyPreset(e.target.value);
                }
            });
        }
        
        function applyPreset(presetType) {
            if (Object.keys(assignments).length > 0) {
                if (!confirm('This will clear current assignments. Continue?')) {
                    return;
                }
            }
            
            assignments = {};
            const availableSeats = getAvailableSeats();
            let sortedStudents = [...students];
            
            switch (presetType) {
                case 'A_TO_Z':
                    sortedStudents.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'Z_TO_A':
                    sortedStudents.sort((a, b) => b.name.localeCompare(a.name));
                    break;
                case 'RANDOM':
                    sortedStudents = shuffleArray(sortedStudents);
                    break;
            }
            
            for (let i = 0; i < Math.min(sortedStudents.length, availableSeats.length); i++) {
                assignments[availableSeats[i]] = sortedStudents[i].name;
            }
            
            refreshGrid();
            updateAssignmentData();
        }
        
        function getAvailableSeats() {
            const seats = [];
            
            for (let r = 0; r < currentLayout.rows; r++) {
                for (let c = 0; c < currentLayout.cols; c++) {
                    const seatId = `${r}-${c}`;
                    if (!currentLayout.disabled.includes(seatId)) {
                        seats.push(seatId);
                    }
                }
            }
            return seats;
        }
        
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }
        
        function refreshGrid() {
            Object.keys(assignments).forEach(seatId => {
                updateSeatDisplay(seatId, assignments[seatId]);
            });
            
            // Clear unassigned seats
            document.querySelectorAll('.seat.available').forEach(seat => {
                if (!assignments[seat.dataset.seatId]) {
                    seat.classList.remove('occupied');
                    seat.classList.add('available');
                    seat.textContent = '';
                    seat.title = '';
                }
            });
        }
        
        function resetAssignment() {
            if (confirm('Reset all seat assignments?')) {
                assignments = {};
                refreshGrid();
                updateAssignmentData();
                document.getElementById('assignmentPreset').value = '';
            }
        }
    </script>
</body>
</html>
