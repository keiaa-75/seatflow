<th:block xmlns:th="http://www.thymeleaf.org" th:fragment="content">
    <th:block th:insert="~{fragments/title-card :: titleCard(${student.studentId != null ? 'Edit Details' : 'New Student'}, true, '/sections/' + ${sectionId} + '/students')}"></th:block>

    <div th:insert="~{fragments/notifications :: notifications}"></div>

    <!-- Content Area -->
    <div class="section-detail-container">
        <!-- Form -->
        <div class="box">
            <form th:action="@{/sections/{sectionId}/students/new(sectionId=${sectionId})}" 
                  th:object="${student}" method="post" id="student-form">
                <input type="hidden" id="sectionIdInput" th:value="${sectionId}">
                
                <!-- Student ID -->
                <div class="field">
                    <label class="label">Student ID *</label>
                    <div class="control">
                        <input type="text" class="input" th:field="*{studentId}" 
                               th:readonly="${student.studentId != null}" required>
                    </div>
                    <p th:if="${#fields.hasErrors('studentId')}" 
                       th:errors="*{studentId}" class="help is-danger"></p>
                </div>

                <!-- First Name -->
                <div class="field">
                    <label class="label">First Name *</label>
                    <div class="control">
                        <input type="text" class="input" th:field="*{firstName}" required>
                    </div>
                    <p th:if="${#fields.hasErrors('firstName')}" 
                       th:errors="*{firstName}" class="help is-danger"></p>
                </div>

                <!-- Middle Initial -->
                <div class="field">
                    <label class="label">Middle Initial</label>
                    <div class="control">
                         <input type="text" class="input" th:field="*{middleInitial}" maxlength="1">
                    </div>
                    <p th:if="${#fields.hasErrors('middleInitial')}" 
                       th:errors="*{middleInitial}" class="help is-danger"></p>
                </div>

                <!-- Last Name -->
                <div class="field">
                    <label class="label">Last Name *</label>
                    <div class="control">
                        <input type="text" class="input" th:field="*{lastName}" required>
                    </div>
                    <p th:if="${#fields.hasErrors('lastName')}" 
                       th:errors="*{lastName}" class="help is-danger"></p>
                </div>

                <!-- Suffix -->
                <div class="field">
                    <label class="label">Suffix</label>
                    <div class="control">
                        <input type="text" class="input" th:field="*{suffix}">
                    </div>
                    <p th:if="${#fields.hasErrors('suffix')}" 
                       th:errors="*{suffix}" class="help is-danger"></p>
                </div>

                <!-- Action Buttons -->
                <div class="field is-grouped mt-5">
                    <div class="control">
                        <button type="submit" class="button is-primary">Save</button>
                    </div>
                    <div class="control" th:if="${student.studentId != null}">
                        <button type="button" class="button is-danger" 
                                onclick="showDeleteConfirm()">Delete</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <th:block th:insert="~{fragments/confirm-modal :: confirmModal('delete-modal', 'Confirm', 'Would you like to delete this student entry permanently?', 'Yes', 'No')}"/>

    <!-- JavaScript -->
    <script>
        function showDeleteConfirm() {
            $('#delete-modal').addClass('is-active');
        }

        function hideDeleteConfirm() {
            $('#delete-modal').removeClass('is-active');
        }

        // Attach event listeners to modal buttons
        $(document).ready(function() {
            $('#delete-modal .confirm-btn').on('click', confirmDelete);
            $('#delete-modal .cancel-btn').on('click', hideDeleteConfirm);
            $('#delete-modal .modal-background').on('click', hideDeleteConfirm);
        });

        function confirmDelete() {
            const studentId = document.getElementById('studentId').value;
            const sectionId = document.getElementById('sectionIdInput').value;

            fetch(`/sections/${sectionId}/students/${studentId}`, {
                method: 'DELETE',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            }).then(response => {
                if (response.ok || response.status === 204) {
                    window.location.href = `/sections/${sectionId}/students?successMessage=Student deleted successfully`;
                } else {
                    hideDeleteConfirm();
                    alert('Failed to delete student');
                }
            }).catch(error => {
                hideDeleteConfirm();
                console.error('Delete error:', error);
                window.location.href = `/sections/${sectionId}/students?successMessage=Student deleted successfully`;
            });
        }

        function showSuccessNotification(message) {
            const $overlay = $('<div class="success-overlay"></div>');
            $overlay.html(`
                <div class="success-notification">
                    <div class="success-header">
                        <h2 class="success-title">Task successful!</h2>
                        <button class="success-dismiss" onclick="hideSuccessNotification()">&times;</button>
                    </div>
                    <p class="success-message">${message}</p>
                </div>
            `);

            $('body').append($overlay);

            setTimeout(() => {
                hideSuccessNotification();
            }, 3000);
        }

        function hideSuccessNotification() {
            const $overlay = $('.success-overlay');
            if ($overlay.length) {
                $overlay.css('opacity', '0');
                setTimeout(() => {
                    $overlay.remove();
                }, 200);
            }
        }

        const successMsg = /*[[${successMessage}]]*/ null;
        if (successMsg) {
            showSuccessNotification(successMsg);
        }

        $('#student-form').on('submit', function(e) {
        });
    </script>
</th:block>