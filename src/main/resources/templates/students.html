<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head('Manage Student Entries')}"></head>
<body>
    <th:block th:insert="~{fragments/navbar :: navbar}"></th:block>
    
    <th:block th:insert="~{fragments/title-card :: titleCard('Manage Student Entries', true, '/sections/' + ${sectionId})}"></th:block>
    
    <div>
        <div th:insert="~{fragments/notifications :: notifications}"></div>

        <!-- Content Area -->
        <div class="section-detail-container">
            <!-- Search Bar -->
            <div class="box mb-4">
                <div class="field has-addons mb-4">
                    <div class="control is-expanded">
                        <input type="text" class="input" id="student-search" placeholder="Search students...">
                    </div>
                    <div class="control">
                        <button class="button is-primary">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Students List -->
            <div id="students-view">
                <div id="students-list">
                    <th:block th:if="${#lists.isEmpty(students)}">
                        <div class="has-text-centered has-text-grey py-5">
                            No students found. Add your first student to get started.
                        </div>
                    </th:block>
                    
                    <th:block th:if="${!#lists.isEmpty(students)}">
                        <th:block th:each="student : ${students}">
                            <a th:href="@{/sections/{sectionId}/students/edit/{id}(sectionId=${sectionId}, id=${student.studentId})}" 
                               class="box mb-3 is-block">
                                <div>
                                    <span class="has-text-weight-medium" th:text="${student.fullName}">John Doe</span>
                                </div>
                                <div>
                                    <span class="tag is-info is-light" th:text="${student.studentId}">20230001</span>
                                </div>
                            </a>
                        </th:block>
                    </th:block>
                </div>

                <!-- Search Results (Hidden by default) -->
                <div id="search-results" class="is-hidden">
                    <div id="search-results-container"></div>
                </div>
            </div>
        </div>

        <!-- Floating Action Button -->
        <a th:href="@{/sections/{sectionId}/students/new(sectionId=${sectionId})}" class="add-fab">
            <i class="fas fa-plus"></i>
        </a>


        <!-- Student List JavaScript -->
        <script>
            $(document).ready(function() {
                const $searchInput = $('#student-search');
                const $studentsView = $('#students-view');
                const $studentsList = $('#students-list');
                const $searchResults = $('#search-results');
                const $searchResultsContainer = $('#search-results-container');

                const students = $('#students-list a').map(function() {
                    const $link = $(this);
                    return {
                        element: $link,
                        name: $link.find('.has-text-weight-medium').text(),
                        id: $link.find('.tag').text()
                    };
                }).get();

                $searchInput.on('input', debounce(function() {
                    const query = $(this).val().toLowerCase().trim();

                    if (query === '') {
                        $studentsList.removeClass('is-hidden');
                        $searchResults.addClass('is-hidden');
                    } else {
                        const filteredStudents = students.filter(student =>
                            student.name.toLowerCase().includes(query) ||
                            student.id.toLowerCase().includes(query)
                        );

                        $studentsList.addClass('is-hidden');
                        $searchResults.removeClass('is-hidden');

                        $searchResultsContainer.html(filteredStudents.length > 0
                            ? filteredStudents.map(student => student.element.prop('outerHTML')).join('')
                            : '<div class="has-text-centered has-text-grey py-5">No students found matching your search.</div>');
                    }
                }, 300));

                function debounce(func, wait) {
                    let timeout;
                    return function executedFunction(...args) {
                        const later = () => {
                            clearTimeout(timeout);
                            func(...args);
                        };
                        clearTimeout(timeout);
                        timeout = setTimeout(later, wait);
                    };
                }
            });
        </script>
    </div>
</body>
</html>